# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

metadata_registry_defaults:
  dataplex:
    projects: <my-gcp-project-id>
    locations: <my-gcp-dataplex-region-id>
    lakes: <my-gcp-dataplex-lake-id>
    zones: <my-gcp-dataplex-zone-id>
row_filters:
  NONE:
    filter_sql_expr: 'True'
  NO_ROWS:
    filter_sql_expr: 'FALSE'
entities:
  INGESTION_TABLE_DAY_LEVEL:
    source_database: BIGQUERY
    table_name: ingestion_day_level
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      INVOICE_ID:
        name: invoice_id
        data_type: FLOAT
        description: |-
          invoice id
      DATE_OF_DAY:
        name: date_of_day
        data_type: DATE
        description: |-
          ingestion date
  INGESTION_TABLE_MONTH_LEVEL:
    source_database: BIGQUERY
    table_name: ingestion_month_level
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      CLIENT_CD:
        name: client_cd
        data_type: INTEGER
        description: |-
          client cd
      MONTH_ID:
        name: month_id
        data_type: INTEGER
        description: |-
          month id %y%m
  INGESTION_TABLE_TIMESTAMP_LEVEL:
    source_database: BIGQUERY
    table_name: ingestion_timestamp_level
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DANA_INGESTION_TIMESTAMP:
        name: dana_ingestion_timestamp
        data_type: TIMESTAMP
        description: |-
          ingestion timestamp
      SALES_MANAGER_ID:
        name: salesManagerId
        data_type: STRING
        description: |-
          sales manager id
  COMPLEX_RULES_TABLE_OK:
    source_database: BIGQUERY
    table_name: complex_rules_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      INVOICE_GROSS_TOTAL_AMOUNT:
        name: dInvoiceGrossTotalAmount
        data_type: NUMERIC
        description: |-
          invoice gross total amount
  COMPLEX_RULES_TABLE_NOT_OK:
    source_database: BIGQUERY
    table_name: complex_rules_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      INVOICE_GROSS_TOTAL_AMOUNT:
        name: dInvoiceGrossTotalAmount
        data_type: NUMERIC
        description: |-
          invoice gross total amount
  DIFFERENT_VOLUMES_PER_PERIOD:
    source_database: BIGQUERY
    table_name: different_volumes_per_period
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DANA_INGESTION_TIMESTAMP:
        name: dana_ingestion_timestamp
        data_type: TIMESTAMP
        description: |-
          Ingestion Timestamp
  REFERENCE_DATA_CHECK_NOT_OK:
    source_database: BIGQUERY
    table_name: reference_check_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      ART_NO:
        name: art_no
        data_type: INTEGER
        description: |-
          Art no
  REFERENCE_DATA_CHECK_OK:
    source_database: BIGQUERY
    table_name: reference_check_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      ART_NO:
        name: art_no
        data_type: INTEGER
        description: |-
          Art no
  REFERENCE_DATA_CHECK_SUBQUERY_NOT_OK:
    source_database: BIGQUERY
    table_name: reference_check_subquery_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      SALE_LINE_LIST:
        name: SaleLineList
        data_type: INTEGER
        description: |-
          Sale Line List
  REFERENCE_DATA_CHECK_SUBQUERY_OK:
    source_database: BIGQUERY
    table_name: reference_check_subquery_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      SALE_LINE_LIST:
        name: SaleLineList
        data_type: INTEGER
        description: |-
          Sale Line List
  REFERENCE_DATA_CHECK_SUBQUERY2_NOT_OK:
    source_database: BIGQUERY
    table_name: reference_check_subquery2_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      YCCOUNTIQENTIYIERS:
        name: yccountIqentiyiers
        data_type: INTEGER
        description: |-
          Record item
  REFERENCE_DATA_CHECK_SUBQUERY2_OK:
    source_database: BIGQUERY
    table_name: reference_check_subquery2_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      YCCOUNTIQENTIYIERS:
        name: yccountIqentiyiers
        data_type: INTEGER
        description: |-
          Record item
  CONFORMITY_CHECK_NOT_OK:
    source_database: BIGQUERY
    table_name: conformity_check_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DATA:
        name: data
        data_type: STRING
        description: |-
          email address
  CONFORMITY_CHECK_OK:
    source_database: BIGQUERY
    table_name: conformity_check_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DATA:
        name: data
        data_type: STRING
        description: |-
          email address
  COMPLETNESS_CHECK_NOT_OK:
    source_database: BIGQUERY
    table_name: completness_check_not_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DATA:
        name: data
        data_type: STRING
        description: |-
          email address
  COMPLETNESS_CHECK_OK:
    source_database: BIGQUERY
    table_name: completness_check_ok
    dataset_name: <my_bigquery_dataset_id>
    project_name: <my-gcp-project-id>
    environment_override:
      TEST:
        environment: test
        override:
          dataset_name: <my_bigquery_dataset_id_2>
          project_name: <my-gcp-project-id-2>
    columns:
      DATA:
        name: data
        data_type: STRING
        description: |-
          email address
rule_bindings:
  T1_NO_DELAYED_INGESTION_DAY_LEVEL_SHOULD_FAIL:
    entity_id: INGESTION_TABLE_DAY_LEVEL
    column_id: INVOICE_ID
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_DAY_LEVEL:
          ingestion_date_day: date_of_day
          elapsed_time_days: 1
    metadata:
      brand: one
  T1_NO_DELAYED_INGESTION_DAY_LEVEL_SHOULD_SUCCEED:
    entity_id: INGESTION_TABLE_DAY_LEVEL
    column_id: INVOICE_ID
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_DAY_LEVEL:
          ingestion_date_day: date_of_day
          elapsed_time_days: 40
    metadata:
      brand: one
  T2_NO_DELAYED_INGESTION_MONTH_LEVEL_SHOULD_SUCCEED:
    entity_id: INGESTION_TABLE_MONTH_LEVEL
    column_id: CLIENT_CD
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_MONTH_LEVEL:
          ingestion_date_month: month_id
          elapsed_time_months: 5
    metadata:
      brand: one
  T2_NO_DELAYED_INGESTION_MONTH_LEVEL_SHOULD_FAIL:
    entity_id: INGESTION_TABLE_MONTH_LEVEL
    column_id: CLIENT_CD
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_MONTH_LEVEL:
          ingestion_date_month: month_id
          elapsed_time_months: 0
    metadata:
      brand: one
  T3_NO_DELAYED_INGESTION_TIMESTAMP_LEVEL_SHOULD_SUCCEED:
    entity_id: INGESTION_TABLE_TIMESTAMP_LEVEL
    column_id: SALES_MANAGER_ID
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_TIMESTAMP_LEVEL:
          ingestion_timestamp: dana_ingestion_timestamp
          elapsed_time_hours: 10000
    metadata:
      brand: one
  T3_NO_DELAYED_INGESTION_TIMESTAMP_LEVEL_SHOULD_FAIL:
    entity_id: INGESTION_TABLE_TIMESTAMP_LEVEL
    column_id: SALES_MANAGER_ID
    row_filter_id: NONE
    rule_ids:
      - NO_DELAYED_INGESTION_TIMESTAMP_LEVEL:
          ingestion_timestamp: dana_ingestion_timestamp
          elapsed_time_hours: 10
    metadata:
      brand: one
  T4_NO_COMPLEX_RULES_MISMATCH_SHOULD_SUCCEED:
    entity_id: COMPLEX_RULES_TABLE_OK
    column_id: INVOICE_GROSS_TOTAL_AMOUNT
    row_filter_id: NONE
    rule_ids:
      - NO_COMPLEX_RULES_MISMATCH
    metadata:
      brand: one
  T4_NO_COMPLEX_RULES_MISMATCH_SHOULD_FAIL:
    entity_id: COMPLEX_RULES_TABLE_NOT_OK
    column_id: INVOICE_GROSS_TOTAL_AMOUNT
    row_filter_id: NONE
    rule_ids:
      - NO_COMPLEX_RULES_MISMATCH
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD_DAY_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-29 00:00:00 UTC"
          interval: day
          threshold: 100
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD_DAY_SHOULD_SUCCEED:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          interval: day
          threshold: 100
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD_MONTH_SHOULD_SUCCEED:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-29 00:00:00 UTC"
          interval: month
          threshold: 4000
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD_DAY_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          avg_from_ts: "2021-12-01 00:00:00 UTC"
          interval: day
          deviation_threshold_pct: 10
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD_DAY_SHOULD_SUCCEED:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-22 00:00:00 UTC"
          avg_from_ts: "2021-12-01 00:00:00 UTC"
          interval: day
          deviation_threshold_pct: 15
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD_MONTH_SHOULD_SUCCEED:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-22 00:00:00 UTC"
          avg_from_ts: "2021-12-01 00:00:00 UTC"
          interval: month
          deviation_threshold_pct: 0.01
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD_DAY_SHOULD_SUCCEED:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-22 00:00:00 UTC"
          interval: day
          N_periods_back: 1
          deviation_threshold_pct: 30
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD_DAY_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          interval: day
          N_periods_back: 2
          deviation_threshold_pct: 10
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD_DAY_PERIOD_TOO_OLD_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          interval: day
          N_periods_back: 10
          deviation_threshold_pct: 10
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD_MONTH_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          interval: month
          N_periods_back: 1
          deviation_threshold_pct: 10
    metadata:
      brand: one
  T5_NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD_YEAR_SHOULD_FAIL:
    entity_id: DIFFERENT_VOLUMES_PER_PERIOD
    column_id: DANA_INGESTION_TIMESTAMP
    row_filter_id: NONE
    rule_ids:
      - NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
          ts_column: dana_ingestion_timestamp
          as_at_ts: "2021-12-23 00:00:00 UTC"
          interval: year
          N_periods_back: 1
          deviation_threshold_pct: 10
    metadata:
      brand: one
  T6_REFERENTIAL_INTEGRITY_VIOLATION_IN_OPERATOR_SHOULD_FAIL:
    entity_id: REFERENCE_DATA_CHECK_NOT_OK
    column_id: ART_NO
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_IN_OPERATOR
    metadata:
      brand: one
  T6_REFERENTIAL_INTEGRITY_VIOLATION_IN_OPERATOR_SHOULD_SUCCEED:
    entity_id: REFERENCE_DATA_CHECK_OK
    column_id: ART_NO
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_IN_OPERATOR
    metadata:
      brand: one
  T6_REFERENTIAL_INTEGRITY_VIOLATION_EXISTS_OPERATOR_SHOULD_FAIL:
    entity_id: REFERENCE_DATA_CHECK_NOT_OK
    column_id: ART_NO
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_EXISTS_OPERATOR
    metadata:
      brand: one
  T6_REFERENTIAL_INTEGRITY_VIOLATION_EXISTS_OPERATOR_SHOULD_SUCCEED:
    entity_id: REFERENCE_DATA_CHECK_OK
    column_id: ART_NO
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_EXISTS_OPERATOR
    metadata:
      brand: one
  T7_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY_SHOULD_FAIL:
    entity_id: REFERENCE_DATA_CHECK_SUBQUERY_NOT_OK
    column_id: SALE_LINE_LIST
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY
    metadata:
      brand: one
  T7_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY_SHOULD_SUCCEED:
    entity_id: REFERENCE_DATA_CHECK_SUBQUERY_OK
    column_id: SALE_LINE_LIST
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY
    metadata:
      brand: one
  T7_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY2_SHOULD_FAIL:
    entity_id: REFERENCE_DATA_CHECK_SUBQUERY2_NOT_OK
    column_id: YCCOUNTIQENTIYIERS
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY2
    metadata:
      brand: one
  T7_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY2_SHOULD_SUCCEED:
    entity_id: REFERENCE_DATA_CHECK_SUBQUERY2_OK
    column_id: YCCOUNTIQENTIYIERS
    row_filter_id: NONE
    rule_ids:
      - NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY2
    metadata:
      brand: one
  T8_CONFORMITY_CHECK_SHOULD_FAIL:
    entity_id: CONFORMITY_CHECK_NOT_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_INVALID_EMAIL
    metadata:
      brand: one
  T8_CONFORMITY_CHECK_SHOULD_SUCCEED:
    entity_id: CONFORMITY_CHECK_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_INVALID_EMAIL
    metadata:
      brand: one
  T9_COMPLETNESS_CHECK_SHOULD_FAIL:
    entity_id: COMPLETNESS_CHECK_NOT_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_ISSUES_WITH_COMPLETNESS:
          condition: data.data IS NOT NULL
          threshold_pct: 100
    metadata:
      brand: one
  T9_COMPLETNESS_CHECK_SHOULD_FAIL2:
    entity_id: COMPLETNESS_CHECK_NOT_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_ISSUES_WITH_COMPLETNESS:
          condition: data.data IS NOT NULL
          threshold_pct: 98
    metadata:
      brand: one
  T9_COMPLETNESS_CHECK_SHOULD_SUCCEED:
    entity_id: COMPLETNESS_CHECK_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_ISSUES_WITH_COMPLETNESS:
          condition: data.data IS NOT NULL
          threshold_pct: 100
    metadata:
      brand: one
  T9_COMPLETNESS_CHECK_SHOULD_SUCCEED2:
    entity_id: COMPLETNESS_CHECK_NOT_OK
    column_id: DATA
    row_filter_id: NONE
    rule_ids:
      - NO_ISSUES_WITH_COMPLETNESS:
          condition: data.data IS NOT NULL
          threshold_pct: 97
    metadata:
      brand: one
rules:
  NO_DELAYED_INGESTION_DAY_LEVEL:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ingestion_date_day
        - elapsed_time_days
      custom_sql_statement: |-
        select * from
        (select count(*) as n
          from data a
          where $ingestion_date_day >= date_sub(current_date(), interval $elapsed_time_days day) 
        )
        where n = 0
  NO_DELAYED_INGESTION_MONTH_LEVEL:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ingestion_date_month
        - elapsed_time_months
      custom_sql_statement: |-
        select * from
        (select count(*) as n
          from data a
          where parse_date('%Y%m',  cast($ingestion_date_month as string)) >= date_sub(date_trunc(current_date(), month), interval $elapsed_time_months month) 
        )
        where n = 0
  NO_DELAYED_INGESTION_TIMESTAMP_LEVEL:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ingestion_timestamp
        - elapsed_time_hours
      custom_sql_statement: |-
        select * from
        (select count(*) as n
          from data a
          where $ingestion_timestamp >= timestamp_sub(current_timestamp(), interval $elapsed_time_hours hour) 
        )
        where n = 0
  NO_COMPLEX_RULES_MISMATCH:
    rule_type: CUSTOM_SQL_EXPR
    params:
      custom_sql_expr: |-
        (select
            sum(SaleLine.dItemTotalNetAmount) + sum(SaleLine.dVatAmount)
          from
            unnest(SaleLineList.SaleLine) as SaleLine
        ) between $column - 0.03 and $column + 0.03
  NO_DIFFERENT_VOLUMES_PER_SPECIFIC_PERIOD:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ts_column
        - as_at_ts
        - interval
        - threshold
      custom_sql_statement: |-
        select *
        from
          (select count(*) as n 
          from data
          where date_trunc(cast($ts_column as date), $interval) = date_trunc(cast(parse_timestamp("%F %T %Z", "$as_at_ts") as date), $interval)
          )
        where  n <= $threshold
  NO_DIFFERENT_VOLUMES_PER_AVERAGE_PERIOD:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ts_column
        - as_at_ts
        - interval
        - avg_from_ts
        - deviation_threshold_pct
      custom_sql_statement: |-
        select *
        from
          (select count(*) as n
          from data
          where date_trunc(cast($ts_column as date), $interval) = date_trunc(cast(parse_timestamp("%F %T %Z", "$as_at_ts") as date), $interval)
          )
        where ifnull(safe_divide(n, (select avg(count_by_interval)
          from (
            select count(*) as count_by_interval
            from data
            where
            date_trunc(cast($ts_column as date), $interval) >= date_trunc(cast(parse_timestamp("%F %T %Z", "$avg_from_ts") as date), $interval)
            group by date_trunc(cast($ts_column as date), $interval)
          )
        )), cast('inf' as float64)) not between (1 - ($deviation_threshold_pct / 100)) and (1 + ($deviation_threshold_pct / 100))
  NO_DIFFERENT_VOLUMES_PER_LAST_PERIOD:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - ts_column
        - as_at_ts
        - interval
        - N_periods_back
        - deviation_threshold_pct
      custom_sql_statement: |-
        select *
        from
          (select count(*) as n
          from data
          where date_trunc(cast($ts_column as date), $interval) = date_trunc(cast(parse_timestamp("%F %T %Z", "$as_at_ts") as date), $interval)
          )
        where ifnull(safe_divide(n, (select count(*) as count_by_interval
          from data
          where
          date_trunc(cast($ts_column as date), $interval) = date_sub(cast(timestamp_trunc("$as_at_ts", $interval) as date), interval $N_periods_back $interval)
        )), cast('inf' as float64)) not between (1 - ($deviation_threshold_pct / 100)) and (1 + ($deviation_threshold_pct / 100))
  NO_REFERENTIAL_INTEGRITY_VIOLATION_IN_OPERATOR:
    rule_type: CUSTOM_SQL_EXPR
    params:
      custom_sql_expr: |-
        $column in (select art_no from clouddq_integration_tests_input_data.reference_data)
  NO_REFERENTIAL_INTEGRITY_VIOLATION_EXISTS_OPERATOR:
    rule_type: CUSTOM_SQL_EXPR
    params:
      custom_sql_expr: |-
        exists (select 1 from clouddq_integration_tests_input_data.reference_data r where r.art_no = data.$column)
  NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY:
    rule_type: CUSTOM_SQL_EXPR
    params:
      custom_sql_expr: |-
        exists (select 1 from unnest($column.saleline) sl inner join clouddq_integration_tests_input_data.reference_data_subquery r on sl.litemnumber = r.subsys_item)
  NO_REFERENTIAL_INTEGRITY_VIOLATION_SUBQUERY2:
    rule_type: CUSTOM_SQL_EXPR
    params:
      custom_sql_expr: |-
        exists (select 1 from unnest($column) t inner join clouddq_integration_tests_input_data.reference_data_subquery2 r on t.iq = r.id and t.type = r.type and t.qyty = r.data)
  NO_INVALID_EMAIL:
    rule_type: REGEX
    params:
      pattern: |-
        ^[\\w\\.-]+@([\\w-]+\\.)+[\\w-]{2,4}$
  NO_ISSUES_WITH_COMPLETNESS:
    rule_type: CUSTOM_SQL_STATEMENT
    params:
      custom_sql_arguments:
        - threshold_pct
        - condition
      custom_sql_statement: |-
        select *
        from
          (select sum(case when $condition then 1 else 0 end) * 100 / count(*) as pct 
          from data
          )
        where  pct < $threshold_pct